# Run unit tests by putting `test` on the command line:
#     ruby players/alex_young.rb test

class AlexYoungPlayer
  def name
    '@alex_young'
  end

  def generate_ship_search_offsets(start)
    (1..6).map { |i| (start / (i * i)) }
  end

  def set_defaults
    @size = 10
    @max = @size * @size
    @ship_search_offsets = generate_ship_search_offsets 0.3
    @mask_offset = 5.0
    @mask_mod = rand(2)
    @board = []
  end

  def new_game
    set_defaults
    add_ship 5
    add_ship 4
    add_ship 3
    add_ship 3
    add_ship 2
  end

  def board
    @board
  end

  def mask_mod=(mask_mod)
    @mask_mod = mask_mod
  end

  def collision?(position)
    occupied = {}
    fleet = (@board + [position]).map { |p| expand_position(*p) }
    fleet.each do |ship|
      ship.each do |xy|
        if xy.any? { |a| a < 0 || a >= @size }
          return true
        elsif occupied[xy]
          return true
        else
          occupied[xy] = true
        end
      end
    end

    return false
  end

  def expand_position(x, y, length, direction)
    dx, dy = direction == :across ? [1, 0] : [0, 1]
    (0...length).map { |i| [x + i * dx, y + i * dy] }
  end

  def add_ship(size)
    guess = ship_placement_guess
    position = guess + [size, [:across, :down][rand(2)]]

    # TODO: Don't allow ships to be adjacent
    if collision? position
      return add_ship(size)
    end

    @board << position
  end

  def flatten_coord(x, y)
    x + (y * @size)
  end

  def expand_coord(i)
    x = i % @size
    y = i / @size
    [x, y]
  end

  # 0: carrier       - 5
  # 1: battleship    - 4
  # 2: sub           - 3
  # 3: sub/destroyer - 3
  # 4: patrol boat   - 2
  def get_ship_id(length)
    length == 2 ? 4 : 5 - length
  end

  def hit?(state, i)
    x, y = expand_coord i
    state[y][x] == :hit
  end

  def average_ship_size(ships_remaining)
    ships_remaining.inject(0) { |i, v| i + v } / ships_remaining.length
  end

  def offset_probabilities(state, ships_remaining)
    seed = (0..@max).map { 0 }

    # TODO: Optimise these values
    offsets = @ship_search_offsets

    average_size = average_ship_size ships_remaining
    @max.times do |i|
      # Offset probabilities exponentially falling based on average ship size
      if hit? state, i
        seed[i] = 1.0

        # Horizontal
        (1..average_size).each do |j|
          offset = offsets[j]
          seed[i - j] += offset if i - j >= 0
          # Don't allow wrapping
          seed[i + j] += offset if (i + j) % @size > 0 and i + j < @max
        end

        # Vertical
        (1..average_size).each do |j|
          offset = offsets[j]
          k = j * @size
          seed[i - k] += offset if i - k >= 0
          seed[i + k] += offset if i + k < @max
        end
      end
    end

    seed
  end

  def mask_even_squares(data)
    data.each_with_index.map do |v, i|
      x, y = expand_coord i
      data[i] = (@mask_mod - ((x + (y % 2)) % 2)) == 0 ? data[i] : data[i] / @mask_offset
    end
  end

  def background_probabilities(state, ships_remaining)
    background = []
    @background_seed ||= background_seed
    @offset_seed = []
    @offset_seed = offset_probabilities(state, ships_remaining) if state

    ships_remaining.each do |ship|
      @max.times do |i|
        background[i] ||= 0
        ship_id = get_ship_id(ship)
        offset = @offset_seed[i] ? @offset_seed[i] : 0.0
        background[i] = background[i] + @background_seed[ship_id][i] + offset
      end
    end

    return background
  end

  def generate_probabilities(state, ships_remaining)
    data = background_probabilities(state, ships_remaining)
  end

  def ship_placement_guess
    ships_remaining = [5, 4, 3, 3, 2]
    @inverted_probabilities ||= (generate_probabilities(nil, ships_remaining).map { |p| 1.0 - p })

    best = 0.0
    prob = 0.0
    guess = [rand(10), rand(10)]

    @size.times do
      y = rand(10)
      x = rand(10)
      prob = @inverted_probabilities[flatten_coord(x, y)]

      if prob > best
        best = prob
        guess = [x, y]
      end
     end

     return guess
  end

  def best_guess(state, ships_remaining, ignore_locations)
    @probabilities = generate_probabilities state, ships_remaining

    best = 0.0
    prob = 0.0
    guess = []

    @probabilities = mask_even_squares @probabilities

    @size.times do |y|
      @size.times do |x|
        prob = @probabilities[flatten_coord(x, y)]

        if prob > best and !ignore_locations.include?([x, y])
          best = prob
          guess = [x, y]
        end
      end
     end

     return { :move => guess, :probability => prob }
  end

  def next_move(state, ships_remaining, ignore_locations = [])
    @previous_attempts ||= []

    guess = best_guess state, ships_remaining, ignore_locations
    move = guess[:move]
    ignore_locations << move

    if @previous_attempts.include? move
      return next_move(state, ships_remaining, ignore_locations)
    else
      @previous_attempts << move
    end

    move
  end

  # ships_remaining: [5,       4,          3,   3,         2]
  #                  [carrier, battleship, sub, destroyer, patrol boat]
  def take_turn(state, ships_remaining)
    next_move state, ships_remaining
  end
end

class AlexYoungPlayer 
  # Seed from: http://thevirtuosi.blogspot.com/2011/10/linear-theory-of-battleship.html
  # 0: carrier
  # 1: battleship
  # 2, 3: sub/destroyer
  # 4: patrol boat
  def background_seed
    [[0.020439636827918852, 0.029095119875159597, 0.03794758121719393, 0.0473987799687899, 0.05739090651156192, 0.05743452972052774, 0.04747134345297205, 0.0379937579798553, 0.02923584905660377, 0.02054922684068662, 0.029154844658816854, 0.03526890339055185, 0.04197340048233792, 0.049969712015888776, 0.05868108951624344, 0.058667967087530144, 0.04996013618953043, 0.042031564760959, 0.035345013477088946, 0.02922230103560789, 0.03791530713576394, 0.042000567456376786, 0.04704397786920131, 0.05385224854589303, 0.0616645623492694, 0.061679245283018866, 0.05374627606752731, 0.0469367995460349, 0.04196971201588878, 0.03795353950915023, 0.04737288977159881, 0.049950489431124984, 0.053917789757412404, 0.06020201447013761, 0.06772237196765499, 0.06781380337636544, 0.06012498226698823, 0.05383103986381047, 0.050005461767626616, 0.0474619094907079, 0.05736600936303022, 0.05874563767910342, 0.06177989785785218, 0.06774705632004539, 0.07532635834870194, 0.07540495105688749, 0.06767555681656973, 0.061730671017165555, 0.05876890339055185, 0.05746020712157753, 0.057404738260746206, 0.05877351397361328, 0.06182345013477089, 0.0677667044970918, 0.07537693289828344, 0.07548361469712016, 0.0676452688324585, 0.061664065824939704, 0.05868087672010214, 0.05747964250248262, 0.04739431124982267, 0.050003617534402044, 0.05394382181869769, 0.06014838984253086, 0.06774294226131367, 0.06782125124131082, 0.06002844375088665, 0.05375592282593275, 0.04989494963824656, 0.04742623067101716, 0.038010710739111934, 0.042018442332245706, 0.04705624911334941, 0.05376805220598666, 0.06165633423180593, 0.06165739821251241, 0.05372010214214782, 0.046891970492268405, 0.041992339338913325, 0.03802241452688325, 0.029213718257908923, 0.03531600226982551, 0.04203433111079586, 0.049915874592140724, 0.05869988650872464, 0.05864406298765782, 0.04987572705348276, 0.04192764931195914, 0.0352408142999007, 0.029194495673145127, 0.02047850758972904, 0.02904546744219038, 0.03786863384877288, 0.04729060859696411, 0.057356007944389276, 0.05739956022130799, 0.047405092920981697, 0.03793616115761101, 0.02916215065966804, 0.02054064406298766],
    [0.017252163427436514, 0.024679599943254363, 0.0320822102425876, 0.04004568023833168, 0.03935827776989644, 0.03935572421620088, 0.04011462618811179, 0.03220449709178607, 0.024711661228543055, 0.0172720244006242, 0.02468300468151511, 0.030377500354660237, 0.03634955312810328, 0.04322279755993758, 0.042432188962973474, 0.04249907788338771, 0.043272095332671304, 0.036435309973045824, 0.030395375230529154, 0.0246898850900837, 0.03216959852461342, 0.03647212370549014, 0.041176833593417506, 0.04716931479642503, 0.04633678535962548, 0.046314087104553835, 0.04728535962547879, 0.041342672719534686, 0.036436444885799404, 0.03221733579231097, 0.040113207547169814, 0.043424244573698395, 0.04726337069087814, 0.052877003830330546, 0.051763583487019434, 0.051720102142147825, 0.05287523052915307, 0.04731146261881118, 0.04329961696694567, 0.04012462760675273, 0.03930486593843098, 0.042545893034472974, 0.04624443183430274, 0.05161874024684352, 0.050591218612569155, 0.05056192367711732, 0.05158944531139169, 0.04629514824797844, 0.04242310966094481, 0.03936331394524046, 0.03926954177897574, 0.04252844375088665, 0.0462274790750461, 0.05154184990778834, 0.050586608029507735, 0.05051517945807916, 0.051566676124272945, 0.046318626755568165, 0.04238884948219605, 0.03940246843523904, 0.04004610583061427, 0.04339771598808342, 0.047284934033196196, 0.05288792736558377, 0.05171095190807207, 0.05172215917151369, 0.05296013618953043, 0.04733345155341183, 0.04324577954319762, 0.040098950205702935, 0.032119307703220315, 0.03647077599659526, 0.04125464604908498, 0.047321889629734715, 0.046346432118030925, 0.046362249964533975, 0.04742786210810044, 0.04133685629167258, 0.036417364165129806, 0.0322342176195205, 0.024634699957440772, 0.030392183288409702, 0.03643928216768336, 0.043261810185841965, 0.04242899702085402, 0.04247091786068946, 0.04336686054759541, 0.03643708327422329, 0.030370265285856148, 0.024710384451695277, 0.017278833877145693, 0.024721733579231096, 0.032236416512980565, 0.04011022840119166, 0.03935551142005958, 0.03941516527166974, 0.04020293658674989, 0.03225244715562491, 0.02470364590722088, 0.01722081146261881],
    [0.01475769612711023, 0.021248262164846078, 0.027786778266420772, 0.026955667470563202, 0.026442048517520217, 0.026412824514115474, 0.026898992764931195, 0.02773535253227408, 0.021249609873740957, 0.014714143850191517, 0.02128684919846787, 0.02657852177613846, 0.032163072776280326, 0.031202865654702795, 0.03070846928642361, 0.03070364590722088, 0.03123237338629593, 0.03229167257767059, 0.026726698822528018, 0.02132848631011491, 0.027822811746346997, 0.032133777840828485, 0.03696623634558093, 0.03578940275216343, 0.03513377784082848, 0.035157114484324015, 0.03579585756844943, 0.036987303163569296, 0.032238899134629025, 0.027776918711874023, 0.02697283302596113, 0.031240388707618104, 0.03584118314654561, 0.034805007802525184, 0.03412838700524897, 0.034176691729323305, 0.03474372251383175, 0.0357720953326713, 0.031215491559086397, 0.026863597673428857, 0.026521634274365158, 0.030676833593417503, 0.03519513406156902, 0.03420641225705774, 0.033652432969215496, 0.03365980990211377, 0.03415009221166123, 0.035121293800539084, 0.030653355085827776, 0.02634941126400908, 0.026455525606469, 0.0306329266562633, 0.0351579656688892, 0.034154419066534256, 0.03355561072492552, 0.033544119733295505, 0.03415505745495815, 0.03519506312952192, 0.03071577528727479, 0.02633437367002412, 0.026925734146687474, 0.0311580366009363, 0.03576365441906654, 0.034716697403887074, 0.03409072208823947, 0.03417130089374379, 0.03476727195346858, 0.035834160873882824, 0.03128784224712725, 0.026907362746488868, 0.02779628316073202, 0.03217456376791034, 0.03698794155199319, 0.0357848631011491, 0.03510022698255071, 0.035186764080011354, 0.0358667896155483, 0.03694502766349837, 0.03225854731167541, 0.027799191374663072, 0.021299191374663073, 0.026635905802241455, 0.03220442615973897, 0.03119931905234785, 0.03060944814867357, 0.030624556674705636, 0.031195843382040005, 0.03213548020995886, 0.026696127110228403, 0.021316782522343595, 0.014762803234501347, 0.021277060575968225, 0.027816853454390694, 0.026934245992339338, 0.026481699531848486, 0.026460703645907222, 0.02700971769045255, 0.02776131366151227, 0.021272520924953894, 0.014710242587601077],
    [0.01468924670165981, 0.02125117037877713, 0.027746417931621505, 0.026902184707050646, 0.026452830188679242, 0.026448361469712016, 0.026927010923535253, 0.02778613987799688, 0.021237196765498654, 0.014742303872889773, 0.02125131224287133, 0.026631366151227125, 0.03224514115477373, 0.031241594552418782, 0.03065441906653426, 0.030629521918002552, 0.031169385728472124, 0.032233721095190807, 0.026596680380195768, 0.021272733721095193, 0.027790608596964105, 0.03219286423606185, 0.036986168250815715, 0.035765640516385304, 0.0351141296637821, 0.03515356788196907, 0.03578131649879416, 0.036965172364874455, 0.032159668038019576, 0.027769187118740248, 0.026992835863243015, 0.031214072918144417, 0.03585891615832033, 0.03478975741239892, 0.03417889062278337, 0.03422194637537239, 0.034800468151510854, 0.035778195488721805, 0.031214285714285715, 0.026894736842105263, 0.026401617250673855, 0.030713718257908924, 0.03523216059015463, 0.03418116044829054, 0.033669811320754715, 0.033667470563200456, 0.0342217335792311, 0.035156121435664635, 0.030691445595119875, 0.026413108242303873, 0.02640246843523904, 0.030644630444034614, 0.03513143708327422, 0.03411178890622783, 0.03370038303305434, 0.03362249964533976, 0.03417215207830898, 0.03510086537097461, 0.030679954603489858, 0.026395871754858847, 0.026880905092920983, 0.03125180876720102, 0.035866718683501206, 0.034679954603489854, 0.0342342885515676, 0.03418456518655128, 0.0347281883955171, 0.03580607178323166, 0.03123116754149525, 0.0269177897574124, 0.027787913179174353, 0.03216782522343595, 0.03698673570719251, 0.03569676549865229, 0.03512859980139027, 0.03517030784508441, 0.03585075897290396, 0.03709824088523195, 0.0322720244006242, 0.027771811604482905, 0.021273443041566177, 0.026688892041424314, 0.032293516810895165, 0.031230671017165555, 0.030701872606043408, 0.03068541637111647, 0.031123634558093347, 0.03215668889204143, 0.02659093488438076, 0.021254787913179175, 0.014718967229394241, 0.02119414101290963, 0.027709036742800397, 0.026879273655837706, 0.02646949921974748, 0.026460136189530428, 0.026954816285998016, 0.027819832600368848, 0.021295857568449424, 0.014744573698396934],
    [0.012739963115335508, 0.018523052915307137, 0.017772379060859697, 0.01735955454674422, 0.017005248971485316, 0.016991700950489432, 0.01728415378067811, 0.017748545893034474, 0.01854560930628458, 0.012747694708469287, 0.018531919421194497, 0.023669031068236628, 0.022634629025393673, 0.02210505036175344, 0.021729536104411973, 0.021747978436657683, 0.022119804227550006, 0.022649170095048944, 0.023666832174776564, 0.018540573130940558, 0.017779330401475387, 0.022682153496949922, 0.021847779826925807, 0.021426798127393957, 0.02115633423180593, 0.021080578805504326, 0.021409348843807633, 0.021847708894878706, 0.022616683217477656, 0.017751099446730034, 0.017284579372960705, 0.02203426017874876, 0.021357000993048658, 0.021028160022698254, 0.020708611150517805, 0.020650375939849624, 0.02097978436657682, 0.021383103986381047, 0.022033905518513263, 0.017226840686622218, 0.016973329550290822, 0.021685203574975175, 0.021059724783657256, 0.02065683075613562, 0.020396084551000143, 0.02040367428003972, 0.020640161725067385, 0.021069868066392397, 0.021717264860263867, 0.016992268406866223, 0.017016172506738543, 0.021715633423180593, 0.021056816569726203, 0.020633635976734288, 0.020419917718825367, 0.02041076748474961, 0.020662363455809334, 0.021109022556390977, 0.0216960561781813, 0.017069938998439494, 0.017267697545751172, 0.022016598099021137, 0.021342530855440488, 0.020984465881685347, 0.020709249538941692, 0.02069995744077174, 0.020937792594694284, 0.021354376507306, 0.022021421478223863, 0.017355227691871186, 0.017786920130514968, 0.022665413533834586, 0.021867782664207688, 0.021424812030075187, 0.021054688608313235, 0.021078167115902966, 0.021317279046673288, 0.021824939707759967, 0.022650943396226416, 0.01779677968506171, 0.018481983260036885, 0.023645126968364308, 0.022745070222726628, 0.022174350971769046, 0.021733082706766917, 0.021703291246985387, 0.02199865229110512, 0.02271761952049936, 0.023636544190665344, 0.018464321180309263, 0.012753085544048802, 0.018567314512696838, 0.0178039438218187, 0.017306142715278763, 0.016958008228117463, 0.016966165413533834, 0.0172656405163853, 0.01781394524045964, 0.018561710880976023, 0.012765356788196907]]
  end
end

if ARGV.include? 'test'
  require 'test/unit'
   
  class TestAlexYoungPlayer < Test::Unit::TestCase
    def setup
      @player = AlexYoungPlayer.new
      @size = 10
      @empty_state = @size.times.map { @size.times.map { :unknown } }
      @ships = @player.new_game
      @player.mask_mod = 0
    end

    # These are the methods Paul's game runner expects
    def test_new_game
      assert_kind_of Array, @ships
      assert_equal 5, @ships.size, 'There should be five ships'
      assert_kind_of Symbol, @ships[0][3]
    end

    def test_take_turn
      turn = @player.take_turn(@empty_state, [5, 4, 3, 3, 2])
      assert_kind_of Array, turn
      assert_equal 2, turn.size
      assert_kind_of Integer, turn[0], 'Turns should be an array of two integers'
    end

    def test_name
      assert_equal '@alex_young', @player.name
    end

    # These are methods I'd like to test
    def test_flatten_coord
      assert_equal 11, @player.flatten_coord(1, 1)
      assert_equal 29, @player.flatten_coord(9, 2)
    end

    def test_expand_coord
      assert_equal [1, 1], @player.expand_coord(11)
      assert_equal [9, 2], @player.expand_coord(29)
    end

    def test_get_ship_id
      assert_equal 0, @player.get_ship_id(5)
      assert_equal 1, @player.get_ship_id(4)
      assert_equal 2, @player.get_ship_id(3)
      assert_equal 4, @player.get_ship_id(2)
    end

    def test_collision?
      player = AlexYoungPlayer.new
      player.set_defaults
      assert_equal false, player.collision?([1, 1, 2, :down])

      player.add_ship 2
      assert_equal true, player.collision?(player.board[0])

      # Out of bounds is a collision as well
      assert_equal true, player.collision?([11, 11, 2, :down])
    end

    def test_hit?
      state = [[:hit, :miss, :unknown]]
      assert @player.hit?(state, 0)
      assert_equal false, @player.hit?(state, 1)
    end

    def test_average_ship_size
      assert_equal 3, @player.average_ship_size([5, 4, 3, 3, 2])
    end
    
    def test_mask_even_squares
      data = (0..@size * @size).map { 1 }
      masked = @player.mask_even_squares(data)

      assert_equal 1, masked[0]
      assert_equal 1, masked[2]

      # The next row shouldn't be one
      assert_not_equal 1, masked[10]
    end
  end
end